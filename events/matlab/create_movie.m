% load all of the data files and create the movie

pgrids = {'pgrid00030' 'pgrid00060' 'pgrid00090' 'pgrid00120' ...
'pgrid00150' 'pgrid00180' 'pgrid00210' 'pgrid00240' 'pgrid00270' 'pgrid00300' 'pgrid00330' ...
'pgrid00360' 'pgrid00390' 'pgrid00420' 'pgrid00450' 'pgrid00480' 'pgrid00510'...
'pgrid00540' 'pgrid00570' 'pgrid00600' 'pgrid00630' 'pgrid00660' 'pgrid00690'...
'pgrid00720' 'pgrid00750' 'pgrid00780' 'pgrid00810' 'pgrid00840' 'pgrid00870'...
'pgrid00900' 'pgrid00930' 'pgrid00960' 'pgrid00990' 'pgrid01020' 'pgrid01050'...
 'pgrid01080' 'pgrid01110' 'pgrid01140' 'pgrid01170'  'pgrid01200' 'pgrid01230'...
'pgrid01260'  'pgrid01290' 'pgrid01320' 'pgrid01350' 'pgrid01380' 'pgrid01410'...
'pgrid01440' 'pgrid01470' 'pgrid01500' 'pgrid01530' 'pgrid01560' 'pgrid01590' 'pgrid01620'...
'pgrid01650' 'pgrid01680' 'pgrid01710' 'pgrid01740' 'pgrid01770'  'pgrid01800'...
 'pgrid01830' 'pgrid01860' 'pgrid01890' 'pgrid01920' 'pgrid01950' 'pgrid01980' 'pgrid02010' ...
'pgrid02040' 'pgrid02070' 'pgrid02100' 'pgrid02130' 'pgrid02160' 'pgrid02190'...
'pgrid02220' 'pgrid02250'  'pgrid02280' 'pgrid02310' 'pgrid02340' 'pgrid02370'...
'pgrid02400' 'pgrid02430' 'pgrid02460' 'pgrid02490' 'pgrid02520' 'pgrid02550' ...
'pgrid02580' 'pgrid02610' 'pgrid02640' 'pgrid02670' 'pgrid02700' 'pgrid02730' ...
'pgrid02760' 'pgrid02790' 'pgrid02820' 'pgrid02850' 'pgrid02880' 'pgrid02910'...
'pgrid02940' 'pgrid02970' 'pgrid03000' 'pgrid03030' 'pgrid03060' 'pgrid03090' 'pgrid03120'...
'pgrid03150' 'pgrid03180' 'pgrid03210' 'pgrid03240'  'pgrid03270' 'pgrid03300'...
'pgrid03330' 'pgrid03360' 'pgrid03390' 'pgrid03420' 'pgrid03450' 'pgrid03480' 'pgrid03510'...
 'pgrid03540' 'pgrid03570' 'pgrid03600' 'pgrid03630' 'pgrid03660' 'pgrid03690'...
'pgrid03720'  'pgrid03750' 'pgrid03780' 'pgrid03810' 'pgrid03840' 'pgrid03870'...
'pgrid03900' 'pgrid03930' 'pgrid03960' 'pgrid03990' 'pgrid04020' 'pgrid04050'...
'pgrid04080' 'pgrid04110' 'pgrid04140' 'pgrid04170' 'pgrid04200'...
'pgrid04230' 'pgrid04260' 'pgrid04290' 'pgrid04320' 'pgrid04350' 'pgrid04380'...
'pgrid04410' 'pgrid04440' 'pgrid04470' 'pgrid04500' 'pgrid04530' 'pgrid04560'...
'pgrid04590' 'pgrid04620' 'pgrid04650' 'pgrid04680' 'pgrid04710' 'pgrid04740'...
'pgrid04770' 'pgrid04800' 'pgrid04830' 'pgrid04860' 'pgrid04890' 'pgrid04920'...
'pgrid04950' 'pgrid04980' 'pgrid05010' 'pgrid05040' 'pgrid05070' 'pgrid05100'...
'pgrid05130' 'pgrid05160' 'pgrid05190' 'pgrid05220' 'pgrid05250' 'pgrid05280'...
'pgrid05310' 'pgrid05340' 'pgrid05370' 'pgrid05400' 'pgrid05430' 'pgrid05460'...
'pgrid05490' 'pgrid05520' 'pgrid05550' 'pgrid05580' 'pgrid05610' 'pgrid05640'...
'pgrid05670' 'pgrid05700' 'pgrid05730' 'pgrid05760' 'pgrid05790' 'pgrid05820'...
'pgrid05850' 'pgrid05880' 'pgrid05910' 'pgrid05940' 'pgrid05970' 'pgrid06000'...
'pgrid06030' 'pgrid06060' 'pgrid06090' 'pgrid06120' 'pgrid06150' 'pgrid06180'...
'pgrid06210' 'pgrid06240' 'pgrid06270' 'pgrid06300' 'pgrid06330' 'pgrid06360'...
'pgrid06390' 'pgrid06420' 'pgrid06450' 'pgrid06480' 'pgrid06510' 'pgrid06540'...
'pgrid06570' 'pgrid06600' 'pgrid06630' 'pgrid06660' 'pgrid06690' 'pgrid06720'...
'pgrid06750' 'pgrid06780' 'pgrid06810' 'pgrid06840' 'pgrid06870' 'pgrid06900'...
'pgrid06930' 'pgrid06960' 'pgrid06990' 'pgrid07020' 'pgrid07050' 'pgrid07080'...
'pgrid07110' 'pgrid07140' 'pgrid07170' 'pgrid07200' 'pgrid07230' 'pgrid07260'...
'pgrid07290' 'pgrid07320' 'pgrid07350' 'pgrid07380' 'pgrid07410' 'pgrid07440'...
'pgrid07470' 'pgrid07500' 'pgrid07530' 'pgrid07560' 'pgrid07590' 'pgrid07620'...
'pgrid07650' 'pgrid07680' 'pgrid07710' 'pgrid07740' 'pgrid07770' 'pgrid07800'...
'pgrid07830' 'pgrid07860' 'pgrid07890' 'pgrid07920' 'pgrid07950' 'pgrid07980'...
'pgrid08010' 'pgrid08040' 'pgrid08070' 'pgrid08100' 'pgrid08130' 'pgrid08160'...
'pgrid08190' 'pgrid08220' 'pgrid08250' 'pgrid08280' 'pgrid08310' 'pgrid08340'...
'pgrid08370' 'pgrid08400' 'pgrid08430' 'pgrid08460' 'pgrid08490' 'pgrid08520'...
'pgrid08550' 'pgrid08580' 'pgrid08610' 'pgrid08640' 'pgrid08670' 'pgrid08700'...
'pgrid08730' 'pgrid08760' 'pgrid08790' 'pgrid08820' 'pgrid08850' 'pgrid08880'...
'pgrid08910' 'pgrid08940' 'pgrid08970' 'pgrid09000' 'pgrid09030' 'pgrid09060'...
'pgrid09090' 'pgrid09120' 'pgrid09150' 'pgrid09180' 'pgrid09210' 'pgrid09240'...
'pgrid09270' 'pgrid09300' 'pgrid09330' 'pgrid09360' 'pgrid09390' 'pgrid09420'...
'pgrid09450' 'pgrid09480' 'pgrid09510' 'pgrid09540' 'pgrid09570' 'pgrid09600' ...
'pgrid09630' 'pgrid09660' 'pgrid09690' 'pgrid09720' 'pgrid09750' 'pgrid09780' ...
'pgrid09810' 'pgrid09840' 'pgrid09870' 'pgrid09900' 'pgrid09930' 'pgrid09960' ...
'pgrid09990'};

colorlimits = [-3.9711e-09, 3.6424e-09]; %these were found by trial and error - using tehse makes the movie much smoother
z = 0:20:20*1000;
x = 0:20:20*1500;
showtrace = 1;

if showtrace ==1
    figure
    set(gcf,'units','centimeters','position',[5 5,18,16])
    % setup the axes
    a1 = subplot(2,1,1);
    set(a1,'units', 'centimeters','position',[1 12.5 15 3],...
        'color','k','xcolor','w','ycolor','w')
    xlabel('time (s)')
    hold on
    
        
    a2 = subplot(2,1,2);
    set(a2,'units', 'centimeters','position',[1 1 15 10],...
        'color','k','xcolor','w','ycolor','w')
    
    set(gcf,'color','k','InvertHardCopy','off')
    
    %load in the wavetrace
    tmp = load(['/export/storage/davidr/play/synthwave/receiver000580.txt']);
    wave_u_full_matrix = zeros(length(tmp)/12,12);
    count =1;
    for i = 1:length(tmp)/12
        wave_u_full_matrix(i,1:12) = tmp(count:count+11)';
        count = count+12;
    end
    wavetrace = wave_u_full_matrix(:,7);
    wavetrace = wavetrace/max(wavetrace);
    time = wave_u_full_matrix(:,1);
    
    mov = avifile('example3.avi')
end

counter2 = 1;
looplen = 150;   % 190   %length(pgrids)
for i=1:looplen; 
   disp(['now capturing frame ', num2str(i), ' of ', num2str(length(pgrids))])
   p = load(['/export/storage/davidr/play/synthwave/moviefiles/',pgrids{i}]);  
   %tmp = p(1:1000,1500:3000);
   if showtrace ==1
       axes(a1)
       ylimits = [min(wavetrace), max(wavetrace)];
       set(gca,'xlim',[0 time(30*looplen)],'ylim',ylimits)  % note counts in 30 because this is how the movie is made
       dt =   1.178709373350360*10^(-3);
       %time = [0:dt:dt*i]
       %wavetrace = [wavetrace, p(750,1)];
       wavetrace_h = plot(time(counter2:counter2+30),wavetrace(counter2:counter2+30),'r','linewidth',2);
       counter2 = counter2+30;
       set(gca,'yticklabel',[])
       axes(a2)
   end
   imagesc(x/1000,z/1000,p,colorlimits);
   if showtrace~=1
    axis equal
    axis tight
   else
       hold on
       plot(11,-0.01,'w^','MarkerSize',8,'MarkerFaceColor','w')
   end
   axis off
   %frames(i) =getframe(gcf);
   title(['Frame ', num2str(i)])
   frames(i) =getframe(gcf);%,[0  0  600  900]);
   maxval(i) = max(max(p));
   minval(i) = min(min(p));
   
   if showtrace ==1
        mov = addframe(mov,frames(i));
   end
end
endmax = max(maxval);
endmin = min(minval); 


mov = close(mov);
save movie_frames.mat frames endmax endmin
